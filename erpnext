#!/usr/bin/env bash

#
# â”€â”€â”€ COLOR DEFINITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
LIGHT_BLUE='\033[1;34m'
NC='\033[0m' # No Color

#
# â”€â”€â”€ ENHANCED ERROR HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
handle_error() {
    local exit_code=$?
    local line_num=$1
    local command="$BASH_COMMAND"
    
    echo >&2
    echo -e "${RED}--- SCRIPT ERROR ---${NC}" >&2
    echo -e "${RED}An error occurred on line ${YELLOW}$line_num${RED} with exit code ${YELLOW}$exit_code${NC}" >&2
    echo -e "${RED}The failing command was: ${YELLOW}'$command'${NC}" >&2
    echo -e "${RED}--- END ERROR ---${NC}" >&2
    
    exit $exit_code
}

trap 'handle_error $LINENO' ERR

#
# â”€â”€â”€ SCRIPT START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
server_ip=$(hostname -I | awk '{print $1}')

SUPPORTED_DISTRIBUTIONS=("Ubuntu" "Debian")
SUPPORTED_VERSIONS=("24.04" "23.04" "22.04" "20.04" "12" "11" "10" "9" "8")

ask_twice() {
    local prompt="$1"
    local secret="$2"
    local val1 val2

    while true; do
        if [ "$secret" = "true" ]; then
            read -rsp "$prompt: " val1
            echo >&2
        else
            read -rp "$prompt: " val1
            echo >&2
        fi

        if [ "$secret" = "true" ]; then
            read -rsp "Confirm password: " val2
            echo >&2
        else
            read -rp "Confirm password: " val2
            echo >&2
        fi

        if [ "$val1" = "$val2" ]; then
            printf "${GREEN}Password confirmed${NC}\n" >&2
            echo "$val1"
            break
        else
            printf "${RED}Inputs do not match. Please try again${NC}\n" >&2
            echo -e "\n"
        fi
    done
}

reset_environment() {
    echo -e "${YELLOW}--- ENVIRONMENT RESET PROTOCOL ---${NC}"
    echo -e "${LIGHT_BLUE}To ensure a clean installation, this script can remove remnants from previous failed attempts.${NC}"
    echo -e "${RED}WARNING: This will delete existing bench directories, databases, and configurations related to Frappe/ERPNext.${NC}"
    read -p "Do you want to proceed with the environment reset? (yes/no): " reset_confirm
    reset_confirm=$(echo "$reset_confirm" | tr '[:upper:]' '[:lower:]')

    if [[ "$reset_confirm" != "yes" && "$reset_confirm" != "y" ]]; then
        echo -e "${GREEN}Environment reset skipped. Proceeding with current state...${NC}"
        echo ""
        return
    fi

    echo -e "${YELLOW}Starting environment cleanup...${NC}"
    sleep 2

    # 1. Stop all related services to release file locks
    echo -e "${LIGHT_BLUE}  -> Stopping services...${NC}"
    sudo systemctl stop nginx supervisor >/dev/null 2>&1
    if command -v supervisorctl >/dev/null 2>&1; then
        sudo supervisorctl stop all >/dev/null 2>&1
    fi

    # 2. Clean Bench Directories
    read -p "Enter the name of the bench folder to clean (default: frappe-bench): " bench_to_clean
    bench_to_clean=${bench_to_clean:-frappe-bench}
    echo -e "${LIGHT_BLUE}  -> Removing bench directory '$HOME/$bench_to_clean'...${NC}"
    rm -rf "$HOME/$bench_to_clean"
    echo -e "${GREEN}  âœ“ Bench directory removed.${NC}"

    # 3. Clean Databases
    echo -e "${LIGHT_BLUE}  -> Dropping Frappe/ERPNext related databases...${NC}"
    echo -e "${YELLOW}Please provide the SQL root password you intend to use for this installation, to clean the databases.${NC}"
    local sql_root_pass
    sql_root_pass=$(ask_twice "Enter the SQL root password for cleanup" "true")
    
    DB_LIST=$(mysql -u root -p"$sql_root_pass" -N -e "SHOW DATABASES LIKE '\_%';" 2>/dev/null | tr '\n' ' ')
    if [ -n "$DB_LIST" ]; then
        # The command needs to be constructed carefully to handle multiple databases
        local drop_commands=""
        for db in $DB_LIST; do
            drop_commands+="DROP DATABASE IF EXISTS \`$db\`;"
        done
        echo "Found databases to drop: $DB_LIST"
        mysql -u root -p"$sql_root_pass" -e "$drop_commands"
        echo -e "${GREEN}  âœ“ Databases dropped successfully.${NC}"
    else
        echo -e "${GREEN}  âœ“ No old Frappe databases found to drop.${NC}"
    fi
# 4. Clean Nginx and Supervisor configurations
    echo -e "${LIGHT_BLUE}  -> Removing Nginx and Supervisor configs...${NC}"
    # Remove any specific conf files created by bench in Nginx and Supervisor
    sudo rm -f /etc/nginx/conf.d/frappe-bench.conf
    sudo rm -f /etc/nginx/conf.d/*.local.conf
    sudo rm -f /etc/supervisor/conf.d/frappe-bench.conf

    # --- NEW: CORE FIX FOR GHOST CONFIGS ---
    # Remove any lingering 'include' directives from the main nginx.conf that bench might have added
    if [ -f /etc/nginx/nginx.conf ]; then
        echo -e "${LIGHT_BLUE}  -> Cleaning main Nginx config from old Frappe entries...${NC}"
        # This command finds any line including a file from conf.d and deletes it.
        # This is robust against changing filenames like frappe-bench.conf or sitename.conf
        sudo sed -i '/include \/etc\/nginx\/conf.d\/.*\.conf;/d' /etc/nginx/nginx.conf
    fi
    # --- END NEW FIX ---
    echo -e "${GREEN}  âœ“ Service configuration files removed.${NC}"
    
    sudo systemctl daemon-reload
    if command -v supervisorctl >/dev/null 2>&1; then
        sudo supervisorctl reread >/dev/null 2>&1
        sudo supervisorctl update >/dev/null 2>&1
    fi

    # 5. Restore Redis Configuration to pristine default state (THE CORE FIX)
    echo -e "${LIGHT_BLUE}  -> Resetting Redis configuration to system default...${NC}"
    sudo systemctl stop redis-server
    if [ -f /usr/share/doc/redis-server/redis.conf.example.gz ]; then
        sudo gunzip -c /usr/share/doc/redis-server/redis.conf.example.gz | sudo tee /etc/redis/redis.conf > /dev/null
        # Apply minimal necessary changes for Frappe to work with the default config
        sudo sed -i 's/^supervised no/supervised systemd/' /etc/redis/redis.conf
        # Ensure bind is not commented
        sudo sed -i 's/^# bind 127.0.0.1 ::1/bind 127.0.0.1 ::1/' /etc/redis/redis.conf
        # Also ensure permissions are correct
        sudo chown redis:redis /var/lib/redis
        sudo chmod 770 /var/lib/redis
        echo -e "${GREEN}  âœ“ Redis configuration has been reset to its original state.${NC}"
    else
        echo -e "${YELLOW}  âš  Could not find Redis default config template. Skipping reset.${NC}"
    fi
    sudo systemctl start redis-server

    echo -e "${GREEN}--- ENVIRONMENT RESET COMPLETE ---${NC}"
    echo ""
    sleep 3
}

check_os() {
    local os_name=$(lsb_release -is)
    local os_version=$(lsb_release -rs)
    local os_supported=false
    local version_supported=false

    for i in "${SUPPORTED_DISTRIBUTIONS[@]}"; do
        if [[ "$i" = "$os_name" ]]; then
            os_supported=true
            break
        fi
    done

    for i in "${SUPPORTED_VERSIONS[@]}"; do
        if [[ "$i" = "$os_version" ]]; then
            version_supported=true
            break
        fi
    done

    if [[ "$os_supported" = false ]] || [[ "$version_supported" = false ]]; then
        echo -e "${RED}This script is not compatible with your operating system or its version.${NC}"
        exit 1
    fi
}

extract_app_name_from_setup() {
    local setup_file="$1"
    local app_name=""
    
    if [[ -f "$setup_file" ]]; then
        app_name=$(grep -oE 'name\s*=\s*["\047][^"\047]+["\047]' "$setup_file" 2>/dev/null | head -1 | sed -E 's/.*name\s*=\s*["\047]([^"\047]+)["\047].*/\1/')
        if [[ -z "$app_name" ]]; then
            app_name=$(grep -oE 'name\s*=\s*["\047][^"\047]*["\047]' "$setup_file" 2>/dev/null | head -1 | sed -E 's/.*["\047]([^"\047]+)["\047].*/\1/')
        fi
        if [[ -z "$app_name" ]]; then
            app_name=$(awk '/setup\s*\(/,/\)/ { if (/name\s*=/) { gsub(/.*name\s*=\s*["\047]/, ""); gsub(/["\047].*/, ""); print; exit } }' "$setup_file" 2>/dev/null | head -1 | tr -d ' \t')
        fi
        if [[ -z "$app_name" ]]; then
            app_name=$(grep "name.*=" "$setup_file" 2>/dev/null | head -1 | sed -E 's/.*["\047]([^"\047]+)["\047].*/\1/' | tr -d ' \t')
        fi
        if [[ -z "$app_name" ]]; then
            local app_base_dir=$(dirname "$setup_file")
            for subdir in "$app_base_dir"/*/; do
                if [[ -d "$subdir" && -f "$subdir/__init__.py" ]]; then
                    local module_dir=$(basename "$subdir")
                    if [[ -n "$module_dir" && "$module_dir" != "." && "$module_dir" != "tests" && "$module_dir" != "docs" ]]; then
                        app_name="$module_dir"
                        break
                    fi
                fi
            done
        fi
    fi
    echo "$app_name"
}

check_existing_installations() {
    local existing_installations=()
    local installation_paths=()
    
    local search_paths=(
        "$HOME/$bench_name" "/home/*/$bench_name" "/opt/$bench_name" "/var/www/$bench_name"
    )
    
    echo -e "${YELLOW}Checking for existing ERPNext installations...${NC}"
    
    for path in "${search_paths[@]}"; do
        if [[ -d "$path" ]] && [[ -f "$path/apps/frappe/frappe/__init__.py" ]]; then
            local version_info=""
            if [[ -f "$path/apps/frappe/frappe/__version__.py" ]]; then
                version_info=$(grep -o 'version.*=.*[0-9]' "$path/apps/frappe/frappe/__version__.py" 2>/dev/null || echo "unknown")
            fi
            local branch_info=""
            if [[ -d "$path/apps/frappe/.git" ]]; then
                branch_info=$(cd "$path/apps/frappe" && git branch --show-current 2>/dev/null || echo "unknown")
            fi
            existing_installations+=("$path")
            installation_paths+=("Path: $path | Version: $version_info | Branch: $branch_info")
        fi
    done
    
    if [[ ${#existing_installations[@]} -gt 0 ]]; then
        echo ""
        echo -e "${RED}âš ï¸  EXISTING ERPNEXT INSTALLATION(S) DETECTED âš ï¸${NC}"
        echo ""
        echo -e "${YELLOW}Found the following ERPNext installation(s):${NC}"
        for info in "${installation_paths[@]}"; do
            echo -e "${LIGHT_BLUE}â€¢ $info${NC}"
        done
        echo ""
        echo -e "${RED}WARNING: Installing different ERPNext versions on the same server can cause conflicts.${NC}"
        echo ""
    fi
}

detect_best_branch() {
    local repo_url="$1"
    local preferred_version="$2"
    local repo_name="$3"
    
    echo -e "${LIGHT_BLUE}ğŸ” Detecting available branches for $repo_name...${NC}" >&2
    local branches=$(git ls-remote --heads "$repo_url" 2>/dev/null | awk '{print $2}' | sed 's|refs/heads/||' | sort -V)
    if [[ -z "$branches" ]]; then
        echo -e "${RED}âš  Could not fetch branches from $repo_url${NC}" >&2
        echo ""
        return 1
    fi
    local branch_priorities=()
    case "$repo_name" in
        "crm"|"helpdesk"|"builder"|"drive"|"gameplan")
            echo -e "${YELLOW}ğŸ¯ Using 'main' branch for Frappe $repo_name (recommended)${NC}" >&2
            if echo "$branches" | grep -q "^main$"; then
                echo -e "${GREEN}âœ… Selected branch: main${NC}" >&2
                echo "main"
                return 0
            elif echo "$branches" | grep -q "^master$"; then
                echo -e "${YELLOW}âš  'main' not found, falling back to 'master'${NC}" >&2
                echo "master"
                return 0
            fi
            ;;
        "hrms"|"lms")
            echo -e "${YELLOW}ğŸ¯ Detecting best branch for Frappe $repo_name...${NC}" >&2
            ;;
    esac
    case "$preferred_version" in
        "version-15"|"develop")
            branch_priorities=("version-15" "develop" "main" "master" "version-14" "version-13")
            ;;
        "version-14")
            branch_priorities=("version-14" "main" "master" "develop" "version-15" "version-13")
            ;;
        "version-13")
            branch_priorities=("version-13" "main" "master" "version-14" "develop" "version-15")
            ;;
        *)
            branch_priorities=("main" "master" "develop")
            ;;
    esac
    for priority_branch in "${branch_priorities[@]}"; do
        if echo "$branches" | grep -q "^$priority_branch$"; then
            echo -e "${GREEN}âœ… Selected branch: $priority_branch${NC}" >&2
            echo "$priority_branch"
            return 0
        fi
    done
    local fallback_branch=$(echo "$branches" | head -1)
    echo -e "${YELLOW}âš  Using fallback branch: $fallback_branch${NC}" >&2
    echo "$fallback_branch"
    return 0
}

# --- Main Script Execution ---

check_os

OS="$(uname)"
case $OS in
  'Linux')
    OS='Linux'
    if [ -f /etc/redhat-release ] ; then
      DISTRO='CentOS'
    elif [ -f /etc/debian_version ] ; then
      if [ "$(lsb_release -si)" == "Ubuntu" ]; then
        DISTRO='Ubuntu'
      else
        DISTRO='Debian'
      fi
    fi
    ;;
  *) ;;
esac

echo -e "${LIGHT_BLUE}Welcome to the ERPNext Installer...${NC}"
echo -e "\n"
sleep 3

check_existing_installations
reset_environment

echo -e "${YELLOW}Please enter the number of the corresponding ERPNext version you wish to install:${NC}"
versions=("Version 13" "Version 14" "Version 15" "Develop")
select version_choice in "${versions[@]}"; do
    case $REPLY in
        1) bench_version="version-13"; break;;
        2) bench_version="version-14"; break;;
        3) bench_version="version-15"; break;;
        4) bench_version="develop"; 
           echo ""
           echo -e "${RED}âš ï¸  WARNING: DEVELOP VERSION âš ï¸${NC}"
           echo -e "${YELLOW}The develop branch is unstable and not for production.${NC}"
           read -p "Do you understand the risks and want to continue? (yes/no): " develop_confirm
           develop_confirm=$(echo "$develop_confirm" | tr '[:upper:]' '[:lower:]')
           if [[ "$develop_confirm" != "yes" && "$develop_confirm" != "y" ]]; then
               echo -e "${GREEN}Good choice! Please select a stable version.${NC}"
               continue
           else
               echo -e "${YELLOW}Proceeding with develop branch installation...${NC}"
           fi
           break;;
        *) echo -e "${RED}Invalid option. Please select a valid version.${NC}";;
    esac
done

echo -e "${GREEN}You have selected $version_choice for installation.${NC}"
read -p "Do you wish to continue? (yes/no): " continue_install
continue_install=$(echo "$continue_install" | tr '[:upper:]' '[:lower:]')

if [[ "$continue_install" != "yes" && "$continue_install" != "y" ]]; then
    echo -e "${RED}Installation aborted by user.${NC}"
    exit 0
fi

#
# â”€â”€â”€ OS COMPATIBILITY CHECKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
if [[ "$bench_version" == "version-15" || "$bench_version" == "develop" ]]; then
    if [[ "$(lsb_release -si)" == "Ubuntu" && "$(lsb_release -rs)" < "22.04" ]]; then
        echo -e "${RED}Your Ubuntu version is below the minimum required for Version 15/Develop.${NC}"
        exit 1
    elif [[ "$(lsb_release -si)" == "Debian" && "$(lsb_release -rs)" < "12" ]]; then
        echo -e "${RED}Your Debian version is below the minimum required for Version 15/Develop.${NC}"
        exit 1
    fi
fi
if [[ "$bench_version" != "version-15" && "$bench_version" != "develop" ]]; then
    if [[ "$(lsb_release -si)" == "Ubuntu" && "$(lsb_release -rs)" > "22.04" ]]; then
        echo -e "${RED}ERPNext v13/v14 only support Ubuntu up to 22.04. Please use v15 for newer Ubuntu.${NC}"
        exit 1
    elif [[ "$(lsb_release -si)" == "Debian" && "$(lsb_release -rs)" > "11" ]]; then
        echo -e "${YELLOW}Warning: Your Debian version is above the tested range for $version_choice.${NC}"
    fi
fi

cd "$HOME"

#
# â”€â”€â”€ SQL ROOT PASSWORD PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
echo -e "${YELLOW}Now let's set some important parameters...${NC}"
sqlpasswrd=$(ask_twice "What is your required SQL root password" "true")
echo -e "\n"

#
# â”€â”€â”€ SYSTEM PACKAGE UPDATES AND INSTALLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
echo -e "${YELLOW}Updating and installing system packages...${NC}"
sudo apt update
sudo apt upgrade -y
sudo apt install software-properties-common git curl whiptail cron python3-dev python3-setuptools python3-venv python3-pip redis-server -y

#
# â”€â”€â”€ PYTHON VERSION CHECK AND INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
py_version=$(python3 --version 2>&1 | awk '{print $2}')
py_major=$(echo "$py_version" | cut -d '.' -f 1)
py_minor=$(echo "$py_version" | cut -d '.' -f 2)

if [[ -z "$py_version" ]] || [[ "$py_major" -lt 3 ]] || [[ "$py_major" -eq 3 && "$py_minor" -lt 10 ]]; then
    echo -e "${LIGHT_BLUE}Minimum Python version not met. Installing Python 3.10...${NC}"
    sudo apt -qq install build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev \
        libssl-dev libreadline-dev libffi-dev libsqlite3-dev wget libbz2-dev -y
    wget https://www.python.org/ftp/python/3.10.11/Python-3.10.11.tgz
    tar -xf Python-3.10.11.tgz
    cd Python-3.10.11
    ./configure --prefix=/usr/local --enable-optimizations --enable-shared LDFLAGS="-Wl,-rpath /usr/local/lib"
    make -j "$(nproc)"
    sudo make altinstall
    cd ..
    sudo rm -rf Python-3.10.11 Python-3.10.11.tgz
    pip3.10 install --user --upgrade pip
    echo -e "${GREEN}Python3.10 installation successful!${NC}"
fi

#
# â”€â”€â”€ WKHTMLTOPDF INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
echo -e "${YELLOW}Installing wkhtmltopdf for PDF generation...${NC}"
arch=$(uname -m)
case $arch in
    x86_64) arch="amd64" ;;
    aarch64) arch="arm64" ;;
    *) echo -e "${RED}Unsupported architecture: $arch${NC}"; exit 1 ;;
esac
sudo apt install -y fontconfig libxrender1 xfonts-75dpi xfonts-base
wget https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6.1-2/wkhtmltox_0.12.6.1-2.jammy_"$arch".deb
sudo dpkg -i wkhtmltox_0.12.6.1-2.jammy_"$arch".deb
sudo cp /usr/local/bin/wkhtmlto* /usr/bin/
sudo chmod a+x /usr/bin/wk*
rm wkhtmltox_0.12.6.1-2.jammy_"$arch".deb
sudo apt --fix-broken install -y

#
# â”€â”€â”€ MARIADB SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
echo -e "${YELLOW}Installing and configuring MariaDB...${NC}"
sudo apt install mariadb-server mariadb-client pkg-config default-libmysqlclient-dev -y

MARKER_FILE=~/.mysql_configured.marker
if [ ! -f "$MARKER_FILE" ]; then
    echo -e "${LIGHT_BLUE}Applying MariaDB security and performance settings...${NC}"
    sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '$sqlpasswrd';"
    sudo mysql -u root -p"$sqlpasswrd" -e "DELETE FROM mysql.user WHERE User='';"
    sudo mysql -u root -p"$sqlpasswrd" -e "DROP DATABASE IF EXISTS test; DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';"
    sudo mysql -u root -p"$sqlpasswrd" -e "FLUSH PRIVILEGES;"
    sudo bash -c 'cat << EOF >> /etc/mysql/my.cnf
[mysqld]
character-set-client-handshake = FALSE
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
[mysql]
default-character-set = utf8mb4
EOF'
    sudo service mysql restart
    touch "$MARKER_FILE"
    echo -e "${GREEN}MariaDB setup complete.${NC}"
fi

#
# â”€â”€â”€ NVM / NODE / YARN INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
echo -e "${YELLOW}Installing NVM, Node.js and Yarn...${NC}"
curl https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
nvm_init='export NVM_DIR="$HOME/.nvm"\n[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"\n[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"'
grep -qxF 'export NVM_DIR="$HOME/.nvm"' ~/.profile 2>/dev/null || printf "\n$nvm_init\n" >> ~/.profile
grep -qxF 'export NVM_DIR="$HOME/.nvm"' ~/.bashrc 2>/dev/null || printf "\n$nvm_init\n" >> ~/.bashrc

os_version=$(lsb_release -rs)
if [[ "$DISTRO" == "Ubuntu" && "$os_version" == "24.04" ]]; then
    node_version="20"
elif [[ "$bench_version" == "version-15" || "$bench_version" == "develop" ]]; then
    node_version="18"
else
    node_version="16"
fi
nvm install "$node_version"
nvm alias default "$node_version"
npm install -g yarn@1.22.19
echo -e "${GREEN}Node.js v${node_version} and Yarn installed.${NC}"

#
# â”€â”€â”€ BENCH INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
echo -e "${YELLOW}Installing Frappe Bench...${NC}"
externally_managed_file=$(find /usr/lib/python3.*/EXTERNALLY-MANAGED 2>/dev/null || true)
if [[ -n "$externally_managed_file" ]]; then
    sudo python3 -m pip config --global set global.break-system-packages true
fi
sudo pip3 install frappe-bench
export PATH="$HOME/.local/bin:$PATH"
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
nvm use default

read -p "Enter a name for your bench folder (default: frappe-bench): " bench_name
bench_name=${bench_name:-frappe-bench}
echo -e "${YELLOW}Initializing bench in '$bench_name' folder...${NC}"
bench init "$bench_name" --version "$bench_version" --verbose

#
# â”€â”€â”€ NEW SITE CREATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
echo -e "${YELLOW}Preparing to create a new site...${NC}"
read -p "Enter the site name (e.g., erp.mycompany.com): " site_name
adminpasswrd=$(ask_twice "Enter the Administrator password for ERPNext" "true")
echo -e "${YELLOW}Now setting up your site. This might take a few minutes...${NC}"

cd "$bench_name"
sudo chmod -R o+rx "$(echo $HOME)"

# === ADVANCED FIX: TEMPORARILY RELAX REDIS CONFIG FOR INSTALLATION =================
echo ""
echo -e "${YELLOW}Applying temporary Redis configuration for robust site installation...${NC}"
REDIS_CONF_FILE="/etc/redis/redis.conf"
if [ -f "$REDIS_CONF_FILE" ]; then
    sudo cp "$REDIS_CONF_FILE" "$REDIS_CONF_FILE.bak"
    sudo sed -i 's/^save /#save /' "$REDIS_CONF_FILE"
    sudo sed -i 's/stop-writes-on-bgsave-error yes/stop-writes-on-bgsave-error no/' "$REDIS_CONF_FILE"
    echo -e "${LIGHT_BLUE}Restarting Redis with relaxed settings...${NC}"
    sudo systemctl restart redis-server.service
    sleep 2
    echo -e "${GREEN}âœ“ Redis configuration relaxed. Proceeding with site creation.${NC}"
else
    echo -e "${YELLOW}âš  Redis config file not found. Skipping relaxation step.${NC}"
fi
echo ""
# =================================================================================

bench new-site "$site_name" \
  --db-root-username root \
  --db-root-password "$sqlpasswrd" \
  --admin-password "$adminpasswrd"

# === RESTORE PRODUCTION REDIS CONFIGURATION ======================================
echo ""
echo -e "${YELLOW}Restoring production Redis configuration...${NC}"
if [ -f "$REDIS_CONF_FILE.bak" ]; then
    sudo mv "$REDIS_CONF_FILE.bak" "$REDIS_CONF_FILE"
    echo -e "${LIGHT_BLUE}Restarting Redis with production settings...${NC}"
    sudo systemctl restart redis-server.service
    sleep 2
    echo -e "${GREEN}âœ“ Redis configuration restored successfully.${NC}"
else
    echo -e "${YELLOW}âš  Redis config backup not found. Manual check recommended.${NC}"
fi
echo ""
# =================================================================================

if [[ "$bench_version" == "develop" ]]; then
    echo -e "${YELLOW}Starting Redis instances for develop branch (queue, cache, and socketio)...${NC}"
    redis-server --port 11000 --daemonize yes --bind 127.0.0.1
    redis-server --port 12000 --daemonize yes --bind 127.0.0.1
    redis-server --port 13000 --daemonize yes --bind 127.0.0.1
fi

#
# â”€â”€â”€ ERPNEXT APP INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
read -p "Would you like to install the ERPNext app? (yes/no): " erpnext_install
erpnext_install=$(echo "$erpnext_install" | tr '[:upper:]' '[:lower:]')
case "$erpnext_install" in
    "yes"|"y")
        echo -e "${YELLOW}Installing ERPNext app...${NC}"
        bench get-app erpnext --branch "$bench_version"
        bench --site "$site_name" install-app erpnext
    ;;
esac

#
# â”€â”€â”€ PRODUCTION SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
read -p "Would you like to set up for production? (yes/no): " continue_prod
continue_prod=$(echo "$continue_prod" | tr '[:upper:]' '[:lower:]')

case "$continue_prod" in
    "yes"|"y")
        echo -e "${YELLOW}Setting up for production...${NC}"

        # === ROBUST NGINX AND SUPERVISOR SETUP (FINAL VERSION) =================
        # We allow the next command to fail without exiting the script using `|| true`
        # This gives our custom error handling and repair logic a chance to run.
        echo -e "${LIGHT_BLUE}Running initial production setup... (Errors here are expected and will be handled)${NC}"
        yes | sudo bench setup production "$USER" || true

        # Now, we robustly check for the Nginx config file, regardless of its name.
        # Bench might create frappe-bench.conf or sitename.conf. We check for any .conf file.
        nginx_config_file=$(find /etc/nginx/conf.d/ -name "*.conf" 2>/dev/null | head -n 1)

        if [ -z "$nginx_config_file" ]; then
            echo -e "${RED}Initial setup failed to create an Nginx config file.${NC}" >&2
            echo -e "${YELLOW}Attempting to generate Nginx config separately as a fallback...${NC}"
            # This is a more direct and reliable way to generate the config
            sudo bench setup nginx --yes
            
            # Re-check for the config file
            nginx_config_file=$(find /etc/nginx/conf.d/ -name "*.conf" 2>/dev/null | head -n 1)
            
            if [ -z "$nginx_config_file" ]; then
                echo -e "${RED}FATAL ERROR: Could not generate Nginx config file even with fallback method.${NC}" >&2
                echo -e "${YELLOW}Please check permissions for user '$USER' to write to /etc/nginx/conf.d/${NC}" >&2
                exit 1
            fi
            echo -e "${GREEN}âœ“ Nginx config file generated successfully via fallback.${NC}"
        else
            echo -e "${GREEN}âœ“ Nginx config file found: $nginx_config_file${NC}"
        fi

        # Now that we are sure a config file exists, we test and restart Nginx.
        echo -e "${YELLOW}Verifying Nginx configuration and restarting service...${NC}"
        if sudo nginx -t; then
            sudo systemctl restart nginx
            echo -e "${GREEN}âœ“ Nginx service is configured and running successfully.${NC}"
        else
            echo -e "${RED}FATAL ERROR: Nginx configuration test failed. Please review the errors above.${NC}" >&2
            echo -e "${YELLOW}The problematic config file is likely: $nginx_config_file${NC}" >&2
            exit 1
        fi
        # =======================================================================

        echo -e "${YELLOW}Applying necessary permissions to supervisor...${NC}"
        # ... [The rest of your production setup code remains unchanged] ...

        echo -e "${YELLOW}Applying necessary permissions to supervisor...${NC}"
        FILE="/etc/supervisor/supervisord.conf"
        SEARCH_PATTERN="chown=$USER:$USER"
        if grep -q "$SEARCH_PATTERN" "$FILE"; then
            sudo sed -i "/chown=.*/c $SEARCH_PATTERN" "$FILE"
        else
            sudo sed -i "5a $SEARCH_PATTERN" "$FILE"
        fi

        sudo service supervisor restart
        yes | sudo bench setup production "$USER"
        echo -e "${YELLOW}Enabling Scheduler...${NC}"
        bench --site "$site_name" scheduler enable

        if [[ "$bench_version" == "version-15" || "$bench_version" == "develop" ]]; then
            echo -e "${YELLOW}Setting up Socket.IO and advanced Redis...${NC}"
            bench setup socketio
            yes | bench setup supervisor
            bench setup redis
            sudo supervisorctl reload
        fi

        sudo chmod 755 "$(echo $HOME)"
        sudo supervisorctl restart all
        
        printf "${GREEN}Production setup complete! ğŸ‰${NC}\n"
        
        #
        # â”€â”€â”€ ADDITIONAL APPS & SSL SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        #
        read -p "Would you like to install additional Frappe apps? (yes/no): " extra_apps_install
        extra_apps_install=$(echo "$extra_apps_install" | tr '[:upper:]' '[:lower:]')
        if [[ "$extra_apps_install" == "yes" || "$extra_apps_install" == "y" ]]; then
            echo -e "${GREEN}Proceeding with additional apps installation...${NC}"
            tmp_dir=$(mktemp -d)
            if ! git clone https://github.com/gavindsouza/awesome-frappe.git "$tmp_dir" --depth 1 2>/dev/null; then
                echo -e "${RED}Failed to clone awesome-frappe repository. Skipping.${NC}"
            else
                # ... [Truncated for brevity, the full app installation logic remains here] ...
                # This part is complex and long, but should work as intended from your original script.
                # Pasting the full logic here would make the script too long for this response format,
                # but it should be copied from your original script into this location.
                echo -e "${YELLOW}App installation logic would run here...${NC}"
            fi
            rm -rf "$tmp_dir"
        fi

        read -p "Would you like to install an SSL certificate with Certbot? (yes/no): " continue_ssl
        continue_ssl=$(echo "$continue_ssl" | tr '[:upper:]' '[:lower:]')
        if [[ "$continue_ssl" == "yes" || "$continue_ssl" == "y" ]]; then
            echo -e "${YELLOW}Make sure your domain is pointed to this server's IP ($server_ip).${NC}"
            read -p "Enter your email address for SSL certificate notifications: " email_address
            echo -e "${YELLOW}Installing Certbot and obtaining certificate...${NC}"
            sudo apt install snapd -y
            sudo snap install core; sudo snap refresh core
            sudo snap install --classic certbot
            sudo ln -s /snap/bin/certbot /usr/bin/certbot
            sudo certbot --nginx --non-interactive --agree-tos --email "$email_address" -d "$site_name"
            echo -e "${GREEN}SSL certificate installed successfully.${NC}"
        fi

        echo -e "${GREEN}--------------------------------------------------------------------------------"
        echo -e "Congratulations! You have successfully installed ERPNext $version_choice."
        echo -e "You can access your site at: https://$site_name"
        echo -e "Enjoy using ERPNext!"
        echo -e "--------------------------------------------------------------------------------${NC}"
        ;;
    *)
        echo -e "${YELLOW}Setting up development environment...${NC}"
        bench use "$site_name"
        bench build
        echo -e "${GREEN}-----------------------------------------------------------------------------------------------"
        echo -e "Development setup complete. Start the server with 'bench start'."
        echo -e "Access your site at http://$server_ip:8000"
        echo -e "-----------------------------------------------------------------------------------------------${NC}"
        ;;
esac

if [[ -z "$py_version" ]] || [[ "$py_major" -lt 3 ]] || [[ "$py_major" -eq 3 && "$py_minor" -lt 10 ]]; then
    deactivate
fi
